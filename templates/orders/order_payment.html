{% extends 'base.html' %}
{% load static %}
{% block title %}订单支付 - {{ order.order_number }} - 跨境电商平台{% endblock %}
{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h1 class="mb-4 text-center">
                <i class="bi bi-credit-card"></i> 订单支付
            </h1>
            <!-- 订单信息 -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle"></i> 订单信息
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>订单号:</strong> {{ order.order_number }}</p>
                            <p><strong>下单时间:</strong> {{ order.created_at|date:"Y-m-d H:i" }}</p>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <p><strong>订单金额:</strong> <span class="h5 text-primary">${{ order.total_amount|floatformat:2 }}</span></p>
                            <p><strong>支付方式:</strong> {{ order.get_payment_method_display }}</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 支付表单 -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-credit-card-2-front"></i> 支付信息
                    </h5>
                </div>
                <div class="card-body">
                    {% if order.payment_method == 'credit_card' %}
                        <form id="payment-form" method="post">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label for="card-number" class="form-label">卡号</label>
                                    <input type="text" class="form-control" id="card-number" 
                                           placeholder="1234 5678 9012 3456" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="expiry" class="form-label">有效期</label>
                                    <input type="text" class="form-control" id="expiry" 
                                           placeholder="MM/YY" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="cvv" class="form-label">CVV</label>
                                    <input type="text" class="form-control" id="cvv" 
                                           placeholder="123" required>
                                </div>
                                <div class="col-12 mb-3">
                                    <label for="card-name" class="form-label">持卡人姓名</label>
                                    <input type="text" class="form-control" id="card-name" 
                                           placeholder="持卡人姓名" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 btn-lg" id="pay-btn">
                                <i class="bi bi-lock"></i> 确认支付 ${{ order.total_amount|floatformat:2 }}
                            </button>
                        </form>
                    {% elif order.payment_method == 'paypal' %}
                        <div class="text-center py-4">
                            <i class="bi bi-paypal display-1 text-primary"></i>
                            <h5 class="mt-3">PayPal 支付</h5>
                            <p class="text-muted">点击下面的按钮跳转到 PayPal 完成支付</p>
                            <button class="btn btn-primary btn-lg" id="paypal-btn">
                                <i class="bi bi-paypal"></i> 使用 PayPal 支付
                            </button>
                        </div>
                    {% elif order.payment_method == 'alipay' %}
                        <div class="text-center py-4">
                            <i class="bi bi-wallet2 display-1 text-success"></i>
                            <h5 class="mt-3">支付宝支付</h5>
                            <p class="text-muted">扫描二维码完成支付</p>
                            <div class="qr-code text-center mb-3">
                                <img src="https://via.placeholder.com/200x200/1677FF/FFFFFF?text=支付宝二维码" alt="支付宝二维码" class="img-fluid">
                            </div>
                            <p class="text-center text-muted">请使用支付宝扫描二维码完成支付</p>
                            <button class="btn btn-success btn-lg" id="alipay-btn">
                                <i class="bi bi-qr-code"></i> 我已支付
                            </button>
                        </div>
                    {% elif order.payment_method == 'wechat' %}
                        <div class="text-center py-4">
                            <i class="bi bi-chat-dots display-1 text-success"></i>
                            <h5 class="mt-3">微信支付</h5>
                            <p class="text-muted">扫描二维码完成支付</p>
                            <div class="qr-code text-center mb-3">
                                <img src="https://via.placeholder.com/200x200/07C160/FFFFFF?text=微信二维码" alt="微信支付二维码" class="img-fluid">
                            </div>
                            <p class="text-center text-muted">请使用微信扫描二维码完成支付</p>
                            <button class="btn btn-success btn-lg" id="wechat-btn">
                                <i class="bi bi-qr-code"></i> 我已支付
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
            <!-- 返回订单列表 -->
            <div class="text-center">
                <a href="{% url 'orders:order_list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> 返回订单列表
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
// 获取CSRF令牌
function getCSRFToken() {
    // 尝试从隐藏的表单字段获取
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfInput && csrfInput.value) {
        return csrfInput.value;
    }
    
    // 尝试从cookie获取
    const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];
    
    if (cookieValue) {
        return cookieValue;
    }
    
    console.warn('CSRF token not found');
    return '';
}

// 信用卡格式化（仅格式化，无验证）
document.getElementById('card-number')?.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\s/g, '');
    let formattedValue = value.replace(/(.{4})/g, '$1 ').trim();
    e.target.value = formattedValue;
});

// 有效期格式化（仅格式化，无验证）
document.getElementById('expiry')?.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length >= 2) {
        value = value.substring(0, 2) + '/' + value.substring(2, 4);
    }
    e.target.value = value;
});

// CVV限制数字长度（仅限制长度，无验证）
document.getElementById('cvv')?.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    e.target.value = value.substring(0, 4);
});

// 简单的表单提交处理
document.getElementById('payment-form')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const payBtn = document.getElementById('pay-btn');
    payBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 处理中...';
    payBtn.disabled = true;
    
    // 模拟支付处理
    setTimeout(() => {
        fetch(`/orders/order/{{ order.pk }}/process-payment/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                payment_method: 'credit_card',
                card_number: document.getElementById('card-number').value.replace(/\\s/g, ''),
                expiry: document.getElementById('expiry').value,
                cvv: document.getElementById('cvv').value,
                card_name: document.getElementById('card-name').value
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                window.location.href = data.redirect_url;
            } else {
                alert(data.message || '支付失败，请重试');
                payBtn.innerHTML = '<i class="bi bi-lock"></i> 确认支付 ${{ order.total_amount|floatformat:2 }}';
                payBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('支付失败，请重试');
            payBtn.innerHTML = '<i class="bi bi-lock"></i> 确认支付 ${{ order.total_amount|floatformat:2 }}';
            payBtn.disabled = false;
        });
    }, 1000);
});

// PayPal支付处理
document.getElementById('paypal-btn')?.addEventListener('click', function() {
    const payBtn = this;
    payBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 跳转中...';
    payBtn.disabled = true;
    
    fetch(`/orders/order/{{ order.pk }}/process-payment/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            payment_method: 'paypal'
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            window.location.href = data.redirect_url;
        } else {
            alert(data.message || '支付失败，请重试');
            payBtn.innerHTML = '<i class="bi bi-paypal"></i> 使用 PayPal 支付';
            payBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('支付失败，请重试');
        payBtn.innerHTML = '<i class="bi bi-paypal"></i> 使用 PayPal 支付';
        payBtn.disabled = false;
    });
});

// 支付宝支付处理
document.getElementById('alipay-btn')?.addEventListener('click', function() {
    const payBtn = this;
    payBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 处理中...';
    payBtn.disabled = true;
    
    fetch(`/orders/order/{{ order.pk }}/process-payment/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            payment_method: 'alipay'
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert('支付成功！');
            window.location.href = data.redirect_url;
        } else {
            alert(data.message || '支付失败，请重试');
            payBtn.innerHTML = '<i class="bi bi-qr-code"></i> 我已支付';
            payBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('支付失败，请重试');
        payBtn.innerHTML = '<i class="bi bi-qr-code"></i> 我已支付';
        payBtn.disabled = false;
    });
});

// 微信支付处理
document.getElementById('wechat-btn')?.addEventListener('click', function() {
    const payBtn = this;
    payBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 处理中...';
    payBtn.disabled = true;
    
    fetch(`/orders/order/{{ order.pk }}/process-payment/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            payment_method: 'wechat'
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert('支付成功！');
            window.location.href = data.redirect_url;
        } else {
            alert(data.message || '支付失败，请重试');
            payBtn.innerHTML = '<i class="bi bi-qr-code"></i> 我已支付';
            payBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('支付失败，请重试');
        payBtn.innerHTML = '<i class="bi bi-qr-code"></i> 我已支付';
        payBtn.disabled = false;
    });
});
</script>
{% endblock %}
