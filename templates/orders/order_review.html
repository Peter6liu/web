{% extends 'base.html' %}
{% load static %}
{% block title %}订单评价 - {{ order.order_number }} - 跨境电商平台{% endblock %}
{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'accounts:home' %}">首页</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'orders:order_list' %}">我的订单</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'orders:order_detail' order.pk %}">{{ order.order_number }}</a></li>
                    <li class="breadcrumb-item active">评价</li>
                </ol>
            </nav>
            <h1 class="mb-4">
                <i class="bi bi-star"></i> 订单评价
                <span class="text-muted fs-5">#{{ order.order_number }}</span>
            </h1>
            <div class="row">
                <div class="col-md-8">
                    <form method="post" id="review-form">
                        {% csrf_token %}
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">商品评价</h5>
                            </div>
                            <div class="card-body">
                                {% for item in order.order_items.all %}
                                <div class="review-item mb-4 pb-4 border-bottom" id="item-{{ item.pk }}">
                                    <div class="d-flex align-items-start">
                                        <img src="{% if item.product.images.first %}{{ item.product.images.first.image.url }}{% else %}{% static 'images/placeholder.svg' %}{% endif %}" 
                                             class="img-thumbnail me-3" alt="{{ item.product.name }}" style="width: 80px; height: 80px; object-fit: cover;">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-2">{{ item.product.name }}</h6>
                                            <p class="text-muted mb-3">
                                                {% if item.product_variant %}
                                                    {% for attr in item.product_variant.attributes.all %}
                                                        <span class="badge bg-light text-dark me-1">{{ attr.attribute.name }}: {{ attr.value }}</span>
                                                    {% endfor %}
                                                {% endif %}
                                            </p>
                                            <div class="rating-section mb-3">
                                                <label class="form-label">商品评分</label>
                                                <div class="star-rating" data-item-id="{{ item.pk }}" id="rating-group-{{ item.pk }}">
                                                    <input type="hidden" name="rating_{{ item.pk }}" id="rating_{{ item.pk }}" value="0" required>
                                                    <i class="bi bi-star-fill" data-rating="1" style="cursor: pointer;"></i>
                                                    <i class="bi bi-star-fill" data-rating="2" style="cursor: pointer;"></i>
                                                    <i class="bi bi-star-fill" data-rating="3" style="cursor: pointer;"></i>
                                                    <i class="bi bi-star-fill" data-rating="4" style="cursor: pointer;"></i>
                                                    <i class="bi bi-star-fill" data-rating="5" style="cursor: pointer;"></i>
                                                    <span class="ms-2 text-muted">请评分</span>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="review_text_{{ item.pk }}" class="form-label">评价内容</label>
                                                <textarea name="review_text_{{ item.pk }}" id="review_text_{{ item.pk }}" 
                                                          class="form-control" rows="3" 
                                                          placeholder="分享您的使用体验，帮助其他买家做出选择..." required></textarea>
                                                <div class="invalid-feedback">请填写评价内容</div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">商品标签（可多选）</label>
                                                <div class="review-tags">
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="checkbox" 
                                                               name="tags_{{ item.pk }}" value="quality" id="quality_{{ item.pk }}">
                                                        <label class="form-check-label" for="quality_{{ item.pk }}">质量好</label>
                                                    </div>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="checkbox" 
                                                               name="tags_{{ item.pk }}" value="value" id="value_{{ item.pk }}">
                                                        <label class="form-check-label" for="value_{{ item.pk }}">性价比高</label>
                                                    </div>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="checkbox" 
                                                               name="tags_{{ item.pk }}" value="shipping" id="shipping_{{ item.pk }}">
                                                        <label class="form-check-label" for="shipping_{{ item.pk }}">发货快</label>
                                                    </div>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="checkbox" 
                                                               name="tags_{{ item.pk }}" value="service" id="service_{{ item.pk }}">
                                                        <label class="form-check-label" for="service_{{ item.pk }}">服务好</label>
                                                    </div>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="checkbox" 
                                                               name="tags_{{ item.pk }}" value="packaging" id="packaging_{{ item.pk }}">
                                                        <label class="form-check-label" for="packaging_{{ item.pk }}">包装好</label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="images_{{ item.pk }}" class="form-label">上传图片（可选）</label>
                                                <input type="file" class="form-control" id="images_{{ item.pk }}" 
                                                       name="images_{{ item.pk }}" multiple accept="image/*">
                                                <div class="image-preview mt-2" id="image-preview-{{ item.pk }}"></div>
                                                <div class="form-text">最多可上传5张图片，每张不超过2MB</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">服务评价</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">物流服务</label>
                                        <div class="star-rating" data-service="shipping">
                                            <input type="hidden" name="shipping_rating" id="shipping_rating" value="5">
                                            <i class="bi bi-star-fill" data-rating="1"></i>
                                            <i class="bi bi-star-fill" data-rating="2"></i>
                                            <i class="bi bi-star-fill" data-rating="3"></i>
                                            <i class="bi bi-star-fill" data-rating="4"></i>
                                            <i class="bi bi-star-fill" data-rating="5"></i>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">客服服务</label>
                                        <div class="star-rating" data-service="customer_service">
                                            <input type="hidden" name="customer_service_rating" id="customer_service_rating" value="5">
                                            <i class="bi bi-star-fill" data-rating="1"></i>
                                            <i class="bi bi-star-fill" data-rating="2"></i>
                                            <i class="bi bi-star-fill" data-rating="3"></i>
                                            <i class="bi bi-star-fill" data-rating="4"></i>
                                            <i class="bi bi-star-fill" data-rating="5"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="service_comment" class="form-label">服务评价（可选）</label>
                                    <textarea name="service_comment" id="service_comment" 
                                              class="form-control" rows="2" 
                                              placeholder="对物流、客服等服务的好评.."></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'orders:order_detail' order.pk %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> 返回订单
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg" id="submit-review">
                                <i class="bi bi-send"></i> 提交评价
                            </button>
                        </div>
                    </form>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm sticky-top" style="top: 20px;">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">评价指南</h5>
                        </div>
                        <div class="card-body">
                            <h6 class="text-primary">优质评价标准</h6>
                            <ul class="small">
                                <li>真实描述商品使用体验</li>
                                <li>分享商品的优缺点</li>
                                <li>上传清晰的实物图片</li>
                                <li>对其他买家有帮助的信息</li>
                            </ul>
                            <h6 class="text-warning mt-3">评价注意事项</h6>
                            <ul class="small">
                                <li>禁止发布虚假评价</li>
                                <li>禁止包含联系方式</li>
                                <li>禁止恶意攻击或诽谤</li>
                                <li>评价需符合法律法规</li>
                            </ul>
                            <div class="mt-3 p-3 bg-light rounded">
                                <h6 class="text-success">评价奖励</h6>
                                <p class="small mb-0">
                                    完成评价后可获得 <strong>10积分</strong><br>
                                    优质评价额外奖励 <strong>20积分</strong>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
// 星级评分功能
document.querySelectorAll('.star-rating').forEach(rating => {
    const stars = rating.querySelectorAll('.bi-star-fill');
    const hiddenInput = rating.querySelector('input[type="hidden"]');
    const itemId = rating.dataset.itemId;
    const service = rating.dataset.service;
    stars.forEach((star, index) => {
        star.addEventListener('click', function() {
            const ratingValue = index + 1;
            hiddenInput.value = ratingValue;
            // 更新星星显示
            stars.forEach((s, i) => {
                if (i < ratingValue) {
                    s.classList.remove('bi-star-fill');
                    s.classList.add('bi-star-fill', 'text-warning');
                } else {
                    s.classList.remove('text-warning');
                    s.classList.add('bi-star-fill');
                }
            });
            // 更新评分文本
            const ratingText = rating.querySelector('span');
            if (ratingText) {
                const ratingTexts = ['', '很差', '一般', '不错', '很好', '非常满意'];
                ratingText.textContent = ratingTexts[ratingValue];
            }
        });
        // 鼠标悬停效果
        star.addEventListener('mouseenter', function() {
            const hoverValue = index + 1;
            stars.forEach((s, i) => {
                if (i < hoverValue) {
                    s.classList.add('text-warning');
                } else {
                    s.classList.remove('text-warning');
                }
            });
        });
    });
    // 鼠标离开恢复原状
    rating.addEventListener('mouseleave', function() {
        const currentRating = parseInt(hiddenInput.value) || 0;
        stars.forEach((s, i) => {
            if (i < currentRating) {
                s.classList.add('text-warning');
            } else {
                s.classList.remove('text-warning');
            }
        });
    });
    // 初始化显示
    const currentRating = parseInt(hiddenInput.value) || 5;
    stars.forEach((s, i) => {
        if (i < currentRating) {
            s.classList.add('text-warning');
        }
    });
});
// 图片预览功能
document.querySelectorAll('input[type="file"]').forEach(input => {
    input.addEventListener('change', function(e) {
        const itemId = this.id.replace('images_', '');
        const preview = document.getElementById(`image-preview-${itemId}`);
        const files = Array.from(e.target.files);
        
        // 清空预览
        preview.innerHTML = '';
        
        // 限制图片数量
        if (files.length > 5) {
            alert('最多只能上传5张图片');
            this.value = '';
            return;
        }
        
        // 验证所有文件
        const validFiles = [];
        for (let file of files) {
            if (file.size > 2 * 1024 * 1024) {
                alert(`图片 ${file.name} 超过2MB限制`);
                continue;
            }
            if (!file.type.startsWith('image/')) {
                alert(`文件 ${file.name} 不是图片格式`);
                continue;
            }
            validFiles.push(file);
        }
        
        // 如果没有有效文件，清空输入
        if (validFiles.length === 0) {
            this.value = '';
            return;
        }
        
        // 预览有效图片
        validFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'img-thumbnail me-2 mb-2';
                img.style.width = '80px';
                img.style.height = '80px';
                img.style.objectFit = 'cover';
                img.title = file.name;
                
                // 添加删除按钮
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-danger btn-sm position-absolute';
                removeBtn.style.cssText = 'top: 0; right: 0; border-radius: 50%; width: 25px; height: 25px; padding: 0;';
                removeBtn.innerHTML = '<i class="bi bi-x"></i>';
                removeBtn.onclick = function() {
                    removeImageFromInput(input, file.name, wrapper);
                };
                
                const wrapper = document.createElement('div');
                wrapper.className = 'position-relative d-inline-block';
                wrapper.appendChild(img);
                wrapper.appendChild(removeBtn);
                preview.appendChild(wrapper);
            };
            reader.readAsDataURL(file);
        });
    });
});

// 从文件输入中移除指定图片
function removeImageFromInput(input, fileNameToRemove, wrapperElement) {
    const dt = new DataTransfer();
    const files = Array.from(input.files);
    
    files.forEach(file => {
        if (file.name !== fileNameToRemove) {
            dt.items.add(file);
        }
    });
    
    input.files = dt.files;
    wrapperElement.remove();
}
// 表单提交
document.getElementById('review-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const errors = validateReviewForm();
    if (errors.length > 0) {
        showValidationErrors(errors);
        return;
    }
    
    submitReviewForm(this);
});

// 验证评价表单
function validateReviewForm() {
    const errors = [];
    
    // 验证每个商品的评分
    document.querySelectorAll('input[type="hidden"][id^="rating_"]').forEach(input => {
        const itemId = input.id.replace('rating_', '');
        if (!input.value || input.value === '0') {
            errors.push(`请为商品 ${itemId} 选择评分`);
        }
    });
    
    // 验证评价内容
    document.querySelectorAll('textarea[id^="review_text_"]').forEach(textarea => {
        const itemId = textarea.id.replace('review_text_', '');
        if (!textarea.value.trim()) {
            errors.push(`请填写商品 ${itemId} 的评价内容`);
        } else if (textarea.value.trim().length < 10) {
            errors.push(`商品 ${itemId} 的评价内容至少需要10个字符`);
        }
    });
    
    return errors;
}

// 显示验证错误
function showValidationErrors(errors) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'alert alert-danger alert-dismissible fade show';
    errorDiv.innerHTML = `
        <strong>请修正以下问题：</strong>
        <ul class="mb-0">
            ${errors.map(error => `<li>${error}</li>`).join('')}
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const form = document.getElementById('review-form');
    form.insertBefore(errorDiv, form.firstChild);
    
    // 自动隐藏错误信息
    setTimeout(() => {
        if (errorDiv.parentNode) {
            errorDiv.remove();
        }
    }, 5000);
}

// 提交评价表单
function submitReviewForm(form) {
    const submitBtn = document.getElementById('submit-review');
    const originalText = submitBtn.innerHTML;
    
    // 显示提交状态
    setSubmitButtonState(submitBtn, '<i class="bi bi-hourglass-split"></i> 提交中...', true);
    
    // 创建FormData对象
    const formData = new FormData(form);
    
    // 提交表单
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => handleSubmitResponse(data, submitBtn, originalText))
    .catch(error => handleSubmitError(error, submitBtn, originalText));
}

// 设置提交按钮状态
function setSubmitButtonState(button, text, disabled) {
    button.innerHTML = text;
    button.disabled = disabled;
}

// 处理提交响应
function handleSubmitResponse(data, submitBtn, originalText) {
    if (data.success) {
        showSuccessMessage('评价提交成功！感谢您的反馈！', () => {
            window.location.href = '{% url "orders:order_detail" order.pk %}';
        });
    } else {
        showErrorMessage(data.message || '提交失败，请重试');
        setSubmitButtonState(submitBtn, originalText, false);
    }
}

// 处理提交错误
function handleSubmitError(error, submitBtn, originalText) {
    console.error('Error:', error);
    showErrorMessage('提交失败，请重试');
    setSubmitButtonState(submitBtn, originalText, false);
}

// 显示成功消息
function showSuccessMessage(message, callback) {
    const successDiv = document.createElement('div');
    successDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    successDiv.style.zIndex = '9999';
    successDiv.innerHTML = `
        <strong>${message}</strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(successDiv);
    
    setTimeout(() => {
        successDiv.remove();
        if (callback) callback();
    }, 1500);
}

// 显示错误消息
function showErrorMessage(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    errorDiv.style.zIndex = '9999';
    errorDiv.innerHTML = `
        <strong>${message}</strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(errorDiv);
    
    setTimeout(() => {
        if (errorDiv.parentNode) {
            errorDiv.remove();
        }
    }, 3000);
}
// 页面加载完成后的初始化
document.addEventListener('DOMContentLoaded', function() {
    initializeReviewPage();
});

// 初始化评价页面
function initializeReviewPage() {
    // 检查订单是否已经评价过
    const orderReviewed = '{% if order.is_reviewed %}true{% else %}false{% endif %}';
    if (orderReviewed) {
        showOrderReviewedNotice();
        disableReviewForm();
        return;
    }
    
    // 初始化表单验证
    initializeFormValidation();
    
    // 初始化评分交互
    initializeRatingInteraction();
}

// 显示订单已评价提示
function showOrderReviewedNotice() {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-info alert-dismissible fade show';
    alertDiv.innerHTML = `
        <strong>提示：</strong> 此订单已经评价过。您可以查看评价详情或联系客服修改。
        <a href="{% url 'orders:order_detail' order.pk %}" class="alert-link">查看订单详情</a>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const form = document.getElementById('review-form');
    form.parentNode.insertBefore(alertDiv, form);
}

// 禁用评价表单
function disableReviewForm() {
    const form = document.getElementById('review-form');
    form.style.display = 'none';
    
    // 显示替代内容
    const alternativeContent = document.createElement('div');
    alternativeContent.className = 'text-center py-5';
    alternativeContent.innerHTML = `
        <div class="mb-3">
            <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
        </div>
        <h4 class="text-muted">订单评价已完成</h4>
        <p class="text-muted">感谢您的宝贵反馈！</p>
        <a href="{% url 'orders:order_detail' order.pk %}" class="btn btn-primary">
            <i class="bi bi-arrow-left"></i> 返回订单详情
        </a>
    `;
    
    form.parentNode.appendChild(alternativeContent);
}

// 初始化表单验证
function initializeFormValidation() {
    // 为所有评分输入添加验证
    document.querySelectorAll('input[type="hidden"][id^="rating_"]').forEach(input => {
        input.addEventListener('change', function() {
            this.classList.remove('is-invalid');
            const itemId = this.id.replace('rating_', '');
            const ratingGroup = document.querySelector(`#rating-group-${itemId}`);
            if (ratingGroup) {
                ratingGroup.classList.remove('is-invalid');
            }
        });
    });
    
    // 为所有评价文本域添加实时字数统计
    document.querySelectorAll('textarea[id^="review_text_"]').forEach(textarea => {
        const itemId = textarea.id.replace('review_text_', '');
        const maxLength = 500;
        
        // 创建字数统计元素
        const charCount = document.createElement('div');
        charCount.className = 'form-text text-end';
        charCount.id = `char-count-${itemId}`;
        charCount.textContent = `0/${maxLength}`;
        
        textarea.parentNode.appendChild(charCount);
        
        // 添加输入事件监听
        textarea.addEventListener('input', function() {
            const currentLength = this.value.length;
            charCount.textContent = `${currentLength}/${maxLength}`;
            
            // 超出字数限制时显示警告
            if (currentLength > maxLength) {
                this.classList.add('is-invalid');
                charCount.classList.add('text-danger');
            } else {
                this.classList.remove('is-invalid');
                charCount.classList.remove('text-danger');
            }
        });
    });
}

// 初始化评分交互
function initializeRatingInteraction() {
    // 为评分组件添加悬停效果
    document.querySelectorAll('.star-rating').forEach(ratingContainer => {
        const stars = ratingContainer.querySelectorAll('.bi-star-fill');
        const itemId = ratingContainer.dataset.itemId;
        
        stars.forEach((star, index) => {
            star.addEventListener('mouseenter', function() {
                highlightStars(itemId, index + 1);
            });
        });
        
        ratingContainer.addEventListener('mouseleave', function() {
            const hiddenInput = ratingContainer.querySelector('input[type="hidden"]');
            const currentRating = parseInt(hiddenInput.value) || 0;
            if (currentRating > 0) {
                highlightStars(itemId, currentRating);
            } else {
                clearStarHighlight(itemId);
            }
        });
    });
}

// 高亮显示指定数量的星星
function highlightStars(itemId, rating) {
    const container = document.querySelector(`#item-${itemId} .star-rating`);
    if (!container) return;
    const stars = container.querySelectorAll('.bi-star-fill');
    stars.forEach((s, i) => {
        if (i < rating) {
            s.classList.add('text-warning');
        } else {
            s.classList.remove('text-warning');
        }
    });
}

// 清除星星高亮
function clearStarHighlight(itemId) {
    const container = document.querySelector(`#item-${itemId} .star-rating`);
    if (!container) return;
    const stars = container.querySelectorAll('.bi-star-fill');
    stars.forEach(s => s.classList.remove('text-warning'));
}
</script>
{% endblock %}
{% block extra_css %}
<style>
/* 评价页面样式 */
.review-item {
    transition: all 0.3s ease;
}
.review-item:hover {
    background-color: #f8f9fa;
}
/* 星级评分样式 */
.star-rating {
    display: inline-flex;
    align-items: center;
    font-size: 1.5rem;
    cursor: pointer;
}
.star-rating .bi-star-fill {
    color: #e9ecef;
    transition: all 0.2s ease;
    margin-right: 0.25rem;
}
.star-rating .bi-star-fill:hover,
.star-rating .bi-star-fill.text-warning {
    color: #ffc107 !important;
    transform: scale(1.1);
}
/* 评价标签样式 */
.review-tags .form-check-inline {
    margin-right: 1rem;
    margin-bottom: 0.5rem;
}
.review-tags .form-check-label {
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    transition: all 0.2s ease;
}
.review-tags .form-check-input:checked + .form-check-label {
    background-color: #007bff;
    color: white;
}
/* 图片预览样式 */
.image-preview img {
    transition: all 0.3s ease;
}
.image-preview img:hover {
    transform: scale(1.05);
}
/* 响应式调整 */
@media (max-width: 768px) {
    .review-item .d-flex {
        flex-direction: column;
        text-align: center;
    }
    .review-item img {
        margin: 0 auto 1rem !important;
    }
    .star-rating {
        justify-content: center;
    }
}
</style>
{% endblock %}
